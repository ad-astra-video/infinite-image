import React, { useState, useEffect, createContext, useContext, useMemo, useRef } from 'react'
import { ConnectButton } from '@rainbow-me/rainbowkit'
import { useAccount, useBalance, useContractRead, useSignTypedData } from 'wagmi'
import { Wallet, CheckCircle, AlertTriangle, DollarSign, X } from 'lucide-react'
import { buildX402TypedData } from '../utils/x402'

const X402SignerContext = createContext({ sign: async () => {}, connected: false })

export function X402SignerProvider({ children }) {
  const { data: account, isConnected } = useAccount()
  const { signTypedDataAsync } = useSignTypedData()
  const accountRef = useRef(account)

  // Update the ref whenever account changes
  useEffect(() => {
    accountRef.current = account
  }, [account])

  // More robust connection check - handle timing issues
  // Primary check: isConnected (this works reliably)
  // Secondary check: account data (may have timing issues)
  const hasAccountData = account && account.address
  // Trust isConnected for connection status, account will be available when needed
  const connected = !!isConnected

  // Debug logging for connection state changes
  useEffect(() => {
    console.log('X402SignerProvider connection state changed:', {
      connected,
      account: account?.address,
      isConnected,
      hasAccount: !!account,
      hasAccountData,
      timestamp: new Date().toISOString()
    })
  }, [connected, account?.address, isConnected, hasAccountData])

  // Memoize the context value to prevent unnecessary re-renders
  const contextValue = useMemo(() => ({
    sign: async (acceptBody) => {
      console.log('X402SignerProvider sign called:', {
        connected,
        account: account?.address,
        isConnected,
        hasSignTypedDataAsync: !!signTypedDataAsync,
        hasAccount: !!account,
        hasAccountData
      })

      // Enhanced connection check - handle timing issues
      if (!isConnected) {
        console.error('Wallet not connected - isConnected is false')
        throw new Error('Wallet not connected')
      }

      // Use the latest account data from the ref
      let currentAccount = accountRef.current
      if (!currentAccount?.address) {
        console.log('Account data missing, waiting for it to become available...')
        // Wait up to 3 seconds for account data to become available
        for (let i = 0; i < 30; i++) {
          await new Promise(resolve => setTimeout(resolve, 100))
          // Check the ref again
          currentAccount = accountRef.current
          if (currentAccount?.address) {
            console.log('Account data became available after waiting')
            break
          }
        }
      }

      // Final check - if we still don't have account data, throw error
      if (!currentAccount?.address) {
        console.error('Account data still missing after waiting - wallet connection failed')
        throw new Error('Wallet account data not available. Please reconnect your wallet.')
      }

      const typedData = buildX402TypedData(acceptBody)
      const signature = await signTypedDataAsync({
        domain: typedData.domain,
        types: typedData.types,
        value: typedData.message,
        primaryType: typedData.primaryType,
      })
      return { typedData, signature, address: currentAccount.address }
    },
    connected
  }), [connected, account?.address, signTypedDataAsync, hasAccountData, isConnected, account])

  return (
    <X402SignerContext.Provider value={contextValue}>
      {children}
    </X402SignerContext.Provider>
  )
}export function useX402Signer() {
  const context = useContext(X402SignerContext)
  console.log('useX402Signer called, returning:', { 
    connected: context.connected,
    hasSignFunction: typeof context.sign === 'function'
  })
  return context
}

function WalletConnect() {
  const { address, isConnected } = useAccount()
  
  // Debug: Log raw wallet state
  useEffect(() => {
    console.log('WalletConnect component - raw wallet state:', {
      address,
      isConnected,
      timestamp: new Date().toISOString()
    })
  }, [address, isConnected])
  
  // USDC contract configuration
  const USDC_CONTRACT_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"
  const USDC_ABI = [
    {
      "constant": true,
      "inputs": [
        { "name": "account", "type": "address" }
      ],
      "name": "balanceOf",
      "outputs": [
        { "name": "", "type": "uint256" }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ]
  
  // Read USDC balance from contract
  const { data: usdcBalanceWei, isLoading: usdcLoading, isError: usdcError } = useContractRead({
    address: USDC_CONTRACT_ADDRESS,
    abi: USDC_ABI,
    functionName: 'balanceOf',
    args: [address],
    enabled: isConnected && !!address,
  })
  
  // Format balance from wei to USD
  const formatUsdcBalance = (balanceWei) => {
    if (!balanceWei) return '0.00'
    try {
      const balance = Number(balanceWei) / 1e6 // USDC has 6 decimals
      return balance.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      })
    } catch (error) {
      console.error('Error formatting USDC balance:', error)
      return '0.00'
    }
  }
  
  const [usdcBalance, setUsdcBalance] = useState(null)
  useEffect(() => {
    if (isConnected && address) {
      setUsdcBalance(formatUsdcBalance(usdcBalanceWei))
    }
  }, [isConnected, address, usdcBalanceWei])

  const shortenAddress = (addr) => {
    if (!addr) return ''
    return `${addr.slice(0, 6)}...${addr.slice(-4)}`
  }

  return (
    <div className="wallet-connect-container">
      <ConnectButton.Custom>
        {({
          account,
          chain,
          openAccountModal,
          openChainModal,
          openConnectModal,
          authenticationStatus,
          mounted,
        }) => {
          const ready = mounted && authenticationStatus !== 'loading'
          const connected = isConnected && account && chain

          return (
            <div
              className="wallet-connect-layout"
              style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                gap: '16px',
                width: '100%',
                padding: '12px 16px',
              }}
            >
              {/* Left side - Balance display */}
              <div className="wallet-balance-left" style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <DollarSign size={18} style={{ color: '#3B82F6' }} />
                <span style={{ fontSize: '14px', fontWeight: '500', color: 'var(--text-primary)' }}>
                  ${usdcLoading ? '...' : (usdcBalance || '0.00')}
                </span>
                <div className="error-icon" style={{ position: 'relative' }}>
                  {(usdcError || (isConnected && !usdcBalanceWei)) && (
                    <AlertTriangle
                      size={16}
                      style={{ color: '#EF4444', cursor: 'pointer' }}
                      onMouseEnter={(e) => {
                        e.target.style.color = '#DC2626'
                      }}
                      onMouseLeave={(e) => {
                        e.target.style.color = '#EF4444'
                      }}
                    />
                  )}
                  <div className="tooltip" style={{
                    position: 'absolute',
                    top: '100%',
                    left: '50%',
                    transform: 'translateX(-50%)',
                    background: 'var(--bg-secondary)',
                    color: 'var(--text-primary)',
                    padding: '8px 12px',
                    borderRadius: '8px',
                    fontSize: '12px',
                    whiteSpace: 'nowrap',
                    zIndex: 1000,
                    marginTop: '4px',
                    boxShadow: 'var(--shadow)',
                    opacity: 0,
                    pointerEvents: 'none',
                    transition: 'opacity 0.3s ease'
                  }}>
                    {usdcError ? 'Unable to read USDC balance' : 'No payments possible, need ETH in wallet on Base chain'}
                  </div>
                </div>
              </div>

              {/* Right side - Wallet controls */}
              <div className="wallet-controls-right" style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                {!ready || (ready && !connected) ? (
                  <button
                    onClick={openConnectModal}
                    type="button"
                    className="wallet-connect-btn-compact"
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                      padding: '10px 16px',
                      background: 'var(--glass-bg)',
                      backdropFilter: 'blur(10px)',
                      border: '1px solid var(--glass-border)',
                      borderRadius: '12px',
                      color: 'var(--text-primary)',
                      fontSize: '14px',
                      fontWeight: '500',
                      cursor: 'pointer',
                      transition: 'var(--transition)',
                      height: '40px',
                    }}
                    disabled={!mounted || authenticationStatus === 'loading'}
                  >
                    <Wallet size={16} />
                    Connect
                  </button>
                ) : (
                  <>
                    <button
                      onClick={openChainModal}
                      type="button"
                      className="chain-button-compact"
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '4px',
                        padding: '6px 8px',
                        background: 'rgba(255, 255, 255, 0.1)',
                        border: '1px solid var(--glass-border)',
                        borderRadius: '8px',
                        fontSize: '12px',
                        color: 'var(--text-secondary)',
                        cursor: 'pointer',
                        transition: 'var(--transition)',
                        height: '36px',
                      }}
                    >
                      {chain.hasIcon && (
                        <img
                          alt={chain.name ?? 'Chain icon'}
                          src={chain.iconUrl}
                          style={{
                            width: 14,
                            height: 14,
                            borderRadius: '50%',
                          }}
                        />
                      )}
                      {chain.name}
                    </button>

                    <button
                      onClick={openAccountModal}
                      type="button"
                      className="account-button-compact"
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        padding: '8px 12px',
                        background: 'var(--glass-bg)',
                        backdropFilter: 'blur(10px)',
                        border: '1px solid var(--glass-border)',
                        borderRadius: '10px',
                        color: 'var(--text-primary)',
                        fontSize: '13px',
                        fontWeight: '500',
                        cursor: 'pointer',
                        transition: 'var(--transition)',
                        height: '40px',
                      }}
                    >
                      <CheckCircle size={14} style={{ color: 'var(--accent-primary)' }} />
                      {shortenAddress(account.address)}
                    </button>
                  </>
                )}
              </div>
            </div>
          )
        }}
      </ConnectButton.Custom>
    </div>
  )
}

export default WalletConnect
